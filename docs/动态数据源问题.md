1、使用@Transaction注解后，不能切换数据源
原因：当使用@Transaction注解后，spring会从数据库连接池中获取主数据源的链接，并将链接和当前线程绑定，绑定后再次切换数据源会失效

解决方式：
1、使用@DSTransaction注解
2、将需要操作另外一个数据数据源的代码提取到另外一个bean中，然后注入到当前bean再调用
注意：方法上需要使用@Transaction注解，并且propagation = Propagation.NOT_SUPPORTED 或者 Propagation.REQUIRES_NEW

区别：当事务的隔离级别被设置为REQUIRES_NEW时，当调用到目标方法事会开启一个新的事物，此时因为@DS注解的存在，会取到切换数据源之后的链接，使用新的数据库连接开启新的事务，当方法发生异常的时候，新事物会回滚并将异常抛到调用方，调用方法出现异常后会导致调用方事务回滚
当事务的隔离级别被设置为NOT_SUPPORTED时，调用目标方法会将当前方法事务暂时挂起


说明：
1、当使用dynamic-datasource-spring-boot-starter动态切换数据源时由于springboot的自动装配，会加载DynamicDataSourceAutoConfiguration类
这个类中定义了一个切面并设置了方法拦截器，通过这个拦截器拦截被@DS注解类或者方法，然后将@DS中对应的数据源名称push到DynamicDataSourceContextHolder中
然后在获取数据源的时候会调用到AbstractRoutingDataSource.getConnection()方法，在这个方法中会从DynamicDataSourceContextHolder取出当前当前数据源并获取这个数据源的连接
至于为什么为调用这个类的这个方法，是因为在DynamicDataSourceAutoConfiguration自动配置的时候创建了通过这个抽象类的子类创建了一个名为dataSource的bean,并且将这个类作为创建DataSourceTransactionManager的数据源，所以后面获取数据库连接都会通过这个数据源来获取

2、为什么在@Transaction中@DS会失效，因为当开始事务之后事务管理器之后再第一次获取数据库链接的时候通过dataSource获取，获取之后会将其设置到ConnectionHolder中，如果后面还有数据库操作并需要事务的话，事务管理器会检查是不是已经存在事务，
如果存在事务那么其实就相当于数据库连接已经存在ConnectionHolder中了，此时就不会再去获取新的数据库连接了（事务隔离级别为requeire_new,和not_support除外），不去获取链接，也就不会调用AbstractRoutingDataSource.getConnection()这个方法，所以@DS失效了
可以查看org.springframework.transaction.support.AbstractPlatformTransactionManager.getTransaction方法


springboot+mybatisplus 获取数据库连接
项目启动：
设置数据源和事务管理器：com.baomidou.mybatisplus.extension.spring.MybatisSqlSessionFactoryBean.buildSqlSessionFactory
--targetConfiguration.setEnvironment()
事务管理器：new SpringManagedTransactionFactory()

获取数据库连接（执行sql）：
1、在真正执行sql的时候会通过代理对象SqlSessionInterceptor开启会话invoke中的getSqlSession方法，然后回依次调用sessionFactory.openSession(executorType)、org.apache.ibatis.session.defaults.DefaultSqlSessionFactory.openSessionFromDataSource;

2、在org.apache.ibatis.session.defaults.DefaultSqlSessionFactory.openSessionFromDataSource，
在这个方法中会将获取到一个org.apache.ibatis.transaction.Transaction对象，并用这个对象创建一个Executor，然后再通过这个执行器创建一个DefaultSqlSession

2、获取链接：在上面已经创建了sqlSession对象，sqlSession对象在执行具体的方法的时会调用getConnection方法，这个方法实际上就是会通过上面创建sqlSession中的executor.tx去获取数据库连接，对应的在springboot和mybatisplus下会通过SpringManagedTransactionFactory类的getConnection()方法获取链接，
而在这个方法中就会通过spring中的ConnectionHodler中去取数据库连接（有事务@Transaction状态下）或者通过dataSource创建新链接（无事务@Transaction状态下）


